#!/usr/bin/env ruby
# frozen_string_literal: true

require 'optparse'
require 'stingray_docs_internal/inline_rewriter'

options = {
  stdin: false,
  write: false, # rewrite files in place
  check: false, # dry-run (exit 1 if any file would change)
  rewrite: false # replace existing comment blocks when inserting
}

parser = OptionParser.new do |opts|
  opts.banner = 'Usage: stingray_docs [options] [files...]'
  opts.on('--stdin', 'Read code from STDIN and print with docs inserted') { options[:stdin] = true }
  opts.on('--write', 'Rewrite files in place') { options[:write] = true }
  opts.on('--check', 'Dry-run: exit 1 if any file would change') { options[:check] = true }
  opts.on('--rewrite', 'Replace existing comment blocks above methods') { options[:rewrite] = true }
  opts.on('--debug', 'Enable debug logs') { ENV['DEBUG_INLINE'] = '1' }
  opts.on('--version', 'Print version and exit') do
    require 'stingray_docs_internal/version'
    puts StingrayDocsInternal::VERSION
    exit
  end
  opts.on('-h', '--help', 'Show this help') do
    puts opts
    exit
  end
end

parser.parse!(ARGV)

def rewrite(code, replace:)
  StingrayDocsInternal::InlineRewriter.insert_comments(code, rewrite: replace)
end

if options[:stdin]
  code = $stdin.read
  puts rewrite(code, replace: options[:rewrite])
  exit 0
end

if ARGV.empty?
  warn 'No input. Use --stdin or pass file paths. See --help.'
  exit 1
end

changed = false

ARGV.each do |path|
  src = File.read(path)
  out = rewrite(src, replace: options[:rewrite])
  if options[:check]
    if out != src
      warn "Would change: #{path}"
      changed = true
    end
  elsif options[:write]
    if out != src
      File.write(path, out)
      puts "Updated: #{path}"
    end
  else
    puts out
  end
end

exit(options[:check] && changed ? 1 : 0)
